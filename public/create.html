<!doctype html>
<html>
<head><meta charset="utf-8"><title>Post Recipe</title></head>
<body>
  <nav>
    <a href="/index.html">Home</a> |
    <a href="/view.html">View recipes</a> |
    <a href="/create.html">Post recipe</a> |
    <a href="/edit.html">Edit recipe</a> |
    <a href="/delete.html">Delete recipe</a>
  </nav>

  <h1>Post Recipe</h1>

  <form id="f">
    <p><input id="title" placeholder="Title" required></p>
    <p><textarea id="ingredients" placeholder="Ingredients" required></textarea></p>
    <p><textarea id="instructions" placeholder="Instructions" required></textarea></p>
    <p><input id="image" type="file" accept="image/*" required></p>
    <button type="submit">Upload image + Create recipe</button>
  </form>

  <pre id="out">Waitingâ€¦</pre>

  <script src="/config.js"></script>
  <script>
    const out = document.getElementById("out");
    const show = (x) => out.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);

    document.getElementById("f").addEventListener("submit", async (e) => {
      e.preventDefault();
      show("Working...");

      const file = document.getElementById("image").files[0];
      if (!file) return show("Pick an image.");

      const title = document.getElementById("title").value.trim();
      const ingredients = document.getElementById("ingredients").value.trim();
      const instructions = document.getElementById("instructions").value.trim();

      // 1) get SAS URL
      const sasResp = await fetch(`${window.API_BASE}/upload-url`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ fileName: file.name, contentType: file.type || "application/octet-stream" })
      });
      const sasText = await sasResp.text();
      let sasBody; try { sasBody = JSON.parse(sasText); } catch { sasBody = sasText; }
      if (!sasResp.ok) return show({ error: "upload-url failed", status: sasResp.status, body: sasBody });

      // 2) upload to blob
      const putResp = await fetch(sasBody.uploadUrl, {
        method: "PUT",
        headers: {
          "x-ms-blob-type": "BlockBlob",
          "Content-Type": file.type || "application/octet-stream"
        },
        body: file
      });
      if (!putResp.ok) return show({ error: "blob upload failed", status: putResp.status, body: await putResp.text() });

      // 3) create recipe
      const createResp = await fetch(`${window.API_BASE}/recipeService`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          authorId: window.AUTHOR_ID,
          title, ingredients, instructions,
          imageUrl: sasBody.blobUrl
        })
      });
      const createText = await createResp.text();
      let createBody; try { createBody = JSON.parse(createText); } catch { createBody = createText; }
      if (!createResp.ok) return show({ error: "create failed", status: createResp.status, body: createBody });

      show({ success: true, recipe: createBody });
    });
  </script>
</body>
</html>
